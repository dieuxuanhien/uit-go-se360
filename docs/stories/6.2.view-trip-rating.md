# Story 6.2: View Trip Rating

## Status

Draft

## Story

**As a** passenger or driver,
**I want** to view the rating for a specific trip,
**so that** I can see the feedback provided.

## Acceptance Criteria

1. `GET /api/trips/{trip_id}/rating` endpoint returns rating object if exists
2. Response includes: rating_id, trip_id, rating (stars), comment, created_at
3. Sensitive info (passenger_id) excluded from driver view
4. Endpoint returns 404 if no rating exists for the trip
5. Endpoint returns 404 if trip does not exist
6. Authorization: Passengers can view ratings they submitted
7. Authorization: Drivers can view ratings for their trips
8. Endpoint returns 403 if user is not authorized (not trip participant)
9. Unit tests cover rating retrieval and authorization logic
10. Integration tests verify correct authorization enforcement

## Tasks / Subtasks

- [ ] **Task 1: Add GET Rating Endpoint to RatingsController** (AC: 1, 2, 6, 7, 8)
  - [ ] Open `services/user-service/src/ratings/ratings.controller.ts`
  - [ ] Add `@Get('trips/:tripId/rating')` endpoint handler
  - [ ] Apply `@UseGuards(JwtAuthGuard)` for authentication
  - [ ] Extract tripId from `@Param('tripId')`
  - [ ] Extract authenticated user from `@CurrentUser()` decorator
  - [ ] Call `ratingsService.getRatingByTripId(tripId, user.id, user.role)`
  - [ ] Return 200 status with RatingDto response (AC: 2)
  - [ ] Add Swagger documentation: @ApiOperation(), @ApiResponse() for 200, 401, 403, 404
  - [ ] Document that passenger_id is excluded from driver view in API docs

- [ ] **Task 2: Implement getRatingByTripId in RatingsService** (AC: 1, 3, 4, 5, 6, 7, 8)
  - [ ] Open `services/user-service/src/ratings/ratings.service.ts`
  - [ ] Add method `getRatingByTripId(tripId: string, userId: string, userRole: UserRole): Promise<RatingDto>`
  - [ ] **Validation Logic:**
    - [ ] Call TripService to fetch trip details: `GET /api/trips/{tripId}`
    - [ ] Verify trip exists - throw NotFoundException if null (AC: 5)
    - [ ] Check user authorization (AC: 6, 7, 8):
      - [ ] If PASSENGER: trip.passengerId must equal userId - throw ForbiddenException if mismatch
      - [ ] If DRIVER: trip.driverId must equal userId - throw ForbiddenException if mismatch
    - [ ] Call ratingsRepository.findByTripId(tripId)
    - [ ] If no rating found, throw NotFoundException (AC: 4)
  - [ ] Map rating to RatingDto
  - [ ] If user is DRIVER, exclude passengerId from response DTO (AC: 3)
  - [ ] Return RatingDto
  - [ ] Add structured logging: log rating retrieval with tripId, userId, userRole

- [ ] **Task 3: Add findByTripId Method to RatingsRepository** (AC: 1, 4)
  - [ ] Open `services/user-service/src/ratings/ratings.repository.ts`
  - [ ] Verify `findByTripId(tripId: string): Promise<Rating | null>` method exists from Story 6.1
  - [ ] If not present, add method that queries ratings table by trip_id
  - [ ] Return Rating object or null if not found
  - [ ] Add structured logging for database query

- [ ] **Task 4: Write Unit Tests for RatingsService.getRatingByTripId** (AC: 9)
  - [ ] Open or create `test/unit/ratings/ratings.service.spec.ts`
  - [ ] Mock RatingsRepository and TripService client
  - [ ] **Test Scenarios:**
    - [ ] Passenger views their own rating → returns RatingDto with all fields
    - [ ] Driver views rating for their trip → returns RatingDto without passengerId (AC: 3)
    - [ ] Passenger attempts to view another passenger's rating → throws ForbiddenException (AC: 8)
    - [ ] Driver attempts to view rating for another driver's trip → throws ForbiddenException (AC: 8)
    - [ ] User views rating for non-existent trip → throws NotFoundException (AC: 5)
    - [ ] User views rating for trip without rating → throws NotFoundException (AC: 4)
    - [ ] Verify authorization checks are enforced correctly (AC: 6, 7, 8)

- [ ] **Task 5: Write Integration Tests for GET Endpoint** (AC: 10)
  - [ ] Open or create `test/integration/ratings.e2e-spec.ts`
  - [ ] Setup: Create test trip with status COMPLETED, passenger, driver, and rating
  - [ ] **Integration Tests:**
    - [ ] GET /trips/{id}/rating with passenger token → 200, returns rating with all fields
    - [ ] GET /trips/{id}/rating with driver token → 200, returns rating without passengerId
    - [ ] GET with different passenger token (not trip participant) → 403 Forbidden
    - [ ] GET with different driver token (not trip participant) → 403 Forbidden
    - [ ] GET for trip without rating → 404 Not Found
    - [ ] GET for non-existent trip → 404 Not Found
    - [ ] GET without authentication → 401 Unauthorized
  - [ ] Verify response includes correct fields: id, tripId, stars, comment, createdAt
  - [ ] Verify passengerId and driverId handling based on requester role (AC: 3)
  - [ ] Verify timestamps are ISO 8601 format

- [ ] **Task 6: Update API Documentation** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Update `services/user-service/README.md`
  - [ ] Document GET /trips/{tripId}/rating endpoint
  - [ ] Response format: RatingDto with fields: id, tripId, stars, comment, createdAt
  - [ ] Note: passengerId excluded from driver view (AC: 3)
  - [ ] List all possible status codes: 200, 401, 403, 404
  - [ ] Add example curl commands for passenger and driver
  - [ ] Document authorization rules clearly

---

## Dev Notes

### Epic Context

This is the **second story** in **Epic 6: Rating & Feedback System**. Story 6.1 (Submit Trip Rating) established the ratings table and POST endpoint for creating ratings. This story adds the read capability, allowing both passengers and drivers to view ratings with appropriate authorization.

**Epic 6 Story Sequence:**

- Story 6.1: Submit trip rating (create ratings table, POST endpoint) - COMPLETED
- **This story (6.2):** View trip rating (GET endpoint with authorization)
- Story 6.3: Calculate and store driver average rating
- Story 6.4: Get driver rating profile
- Story 6.5: Get driver recent ratings
- Story 6.6: Ratings analytics dashboard

### Previous Story Dependencies

**From Story 6.1 (Submit Trip Rating):**

- Ratings table exists with schema: id, trip_id (unique), passenger_id, driver_id, stars (1-5), comment (nullable, max 500), created_at
- RatingsRepository with `findByTripId(tripId: string): Promise<Rating | null>` method
- RatingsService already has TripService client integration
- RatingDto exists: `{ id, tripId, passengerId, driverId, stars, comment, createdAt }`
- Authorization pattern established: JWT authentication with @CurrentUser() decorator
- Error handling patterns: NotFoundException, ForbiddenException, BadRequestException
- Structured logging pattern in place

**Key Learnings from Story 6.1:**

- Always validate trip exists before performing operations
- Always check authorization (user matches trip participant)
- Use structured logging with context (tripId, userId, action)
- Map database models to DTOs before returning from controllers
- Cross-service calls to TripService already working

### Data Models

[Source: architecture/section-4-data-models.md#4.5-rating-model]

**Rating Model:**

```typescript
export interface Rating {
  id: string; // UUID
  tripId: string; // UUID - Foreign key to Trip (unique constraint)
  passengerId: string; // UUID - Foreign key to User (PASSENGER)
  driverId: string; // UUID - Foreign key to User (DRIVER)
  stars: number; // Integer 1-5
  comment: string | null; // Optional text feedback, max 500 chars
  createdAt: Date; // Rating submission timestamp
}

export interface RatingDTO {
  id: string;
  tripId: string;
  passengerId?: string; // Optional - excluded for driver view
  driverId?: string; // Optional - may be excluded in some contexts
  stars: number;
  comment: string | null;
  createdAt: Date;
}
```

**Key Difference from Story 6.1:**

- This story focuses on READ operation (GET), not CREATE (POST)
- Response DTO must conditionally exclude passengerId for driver view (AC: 3)

### API Specification

[Source: architecture/section-5-api-specification.md]

**Endpoint:** `GET /api/trips/{trip_id}/rating`

**Authentication:** Required - JWT Bearer token

**Authorization:**

- Passengers can view ratings they submitted (trip.passengerId === userId)
- Drivers can view ratings for their trips (trip.driverId === userId)
- Other users receive 403 Forbidden

**Path Parameters:**

- `trip_id`: UUID - Trip identifier

**Response 200 OK (Passenger view):**

```json
{
  "id": "rating-uuid",
  "tripId": "trip-uuid",
  "passengerId": "passenger-uuid",
  "driverId": "driver-uuid",
  "stars": 5,
  "comment": "Excellent driver! Very friendly and safe driving.",
  "createdAt": "2025-11-01T10:40:00Z"
}
```

**Response 200 OK (Driver view - passengerId excluded):**

```json
{
  "id": "rating-uuid",
  "tripId": "trip-uuid",
  "driverId": "driver-uuid",
  "stars": 5,
  "comment": "Excellent driver! Very friendly and safe driving.",
  "createdAt": "2025-11-01T10:40:00Z"
}
```

**Response 401 Unauthorized:** Missing/invalid JWT token

```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required",
    "timestamp": "2025-11-01T10:40:30Z"
  }
}
```

**Response 403 Forbidden:** User is not trip participant

```json
{
  "error": {
    "code": "FORBIDDEN",
    "message": "You are not authorized to view this rating",
    "timestamp": "2025-11-01T10:40:30Z"
  }
}
```

**Response 404 Not Found (Trip not found):**

```json
{
  "error": {
    "code": "TRIP_NOT_FOUND",
    "message": "Trip with ID {trip_id} not found",
    "timestamp": "2025-11-01T10:40:30Z"
  }
}
```

**Response 404 Not Found (No rating exists):**

```json
{
  "error": {
    "code": "RATING_NOT_FOUND",
    "message": "No rating found for trip {trip_id}",
    "timestamp": "2025-11-01T10:40:30Z"
  }
}
```

### Core Workflow

[Source: architecture/section-8-core-workflows.md]

**Rating Retrieval Sequence:**

```
Passenger/Driver Client
  → GET /trips/{tripId}/rating with JWT
  → RatingsService validates JWT and extracts userId, userRole
  → RatingsService calls TripService: GET /trips/{tripId}
  → Validate trip exists (404 if not)
  → Validate authorization:
      - If PASSENGER: trip.passengerId === userId (403 if mismatch)
      - If DRIVER: trip.driverId === userId (403 if mismatch)
  → Call ratingsRepository.findByTripId(tripId)
  → If no rating found, return 404
  → Map to RatingDto
  → If requester is DRIVER, exclude passengerId from DTO
  ← Returns 200 with rating object
```

**Business Rules:**

1. **Authorization by Role:** Passengers can only view their own ratings; drivers can only view ratings for their trips
2. **Privacy Protection:** Driver view excludes passenger_id to protect passenger privacy (AC: 3)
3. **Trip Validation:** Must verify trip exists before checking rating
4. **Rating Existence:** Must return 404 if trip has no rating (AC: 4)

### File Locations

[Source: architecture/section-10-unified-project-structure.md]

**Files to Modify:**

```
services/user-service/
├── src/
│   └── ratings/
│       ├── ratings.controller.ts      # ADD GET /trips/:tripId/rating
│       ├── ratings.service.ts         # ADD getRatingByTripId method
│       ├── ratings.repository.ts      # Verify findByTripId exists (from 6.1)
│       └── dto/
│           └── rating.dto.ts          # May need conditional field handling
├── test/
│   ├── unit/
│   │   └── ratings/
│   │       └── ratings.service.spec.ts # ADD getRatingByTripId tests
│   └── integration/
│       └── ratings.e2e-spec.ts        # ADD GET endpoint tests
└── README.md                          # Update with GET endpoint docs
```

**No New Files:** All files already exist from Story 6.1

### Coding Standards

[Source: architecture/section-15-coding-standards.md]

**Critical Standards for This Story:**

1. **Authorization Pattern:**

   ```typescript
   // Verify user is trip participant
   const trip = await this.tripServiceClient.getTripById(tripId);
   if (!trip) {
     throw new NotFoundException(`Trip ${tripId} not found`);
   }

   if (userRole === UserRole.PASSENGER) {
     if (trip.passengerId !== userId) {
       throw new ForbiddenException('You are not authorized to view this rating');
     }
   } else if (userRole === UserRole.DRIVER) {
     if (trip.driverId !== userId) {
       throw new ForbiddenException('You are not authorized to view this rating');
     }
   } else {
     throw new ForbiddenException('Invalid user role');
   }
   ```

2. **Conditional DTO Field Exclusion:**

   ```typescript
   private mapToDto(rating: Rating, userRole: UserRole): RatingDto {
     const dto: RatingDto = {
       id: rating.id,
       tripId: rating.tripId,
       stars: rating.stars,
       comment: rating.comment,
       createdAt: rating.createdAt,
     };

     // Include driverId only if requester is passenger
     if (userRole === UserRole.PASSENGER) {
       dto.passengerId = rating.passengerId;
       dto.driverId = rating.driverId;
     } else if (userRole === UserRole.DRIVER) {
       // Exclude passengerId for driver view (AC: 3)
       dto.driverId = rating.driverId;
     }

     return dto;
   }
   ```

3. **Error Handling:** Use NestJS exception classes:
   - `NotFoundException` - Trip not found, Rating not found
   - `ForbiddenException` - Not authorized (not trip participant)
   - `UnauthorizedException` - Missing/invalid token

4. **HTTP Status Codes:**
   - 200 OK: Rating retrieved successfully
   - 401 Unauthorized: Missing/invalid token
   - 403 Forbidden: Not authorized (not trip participant)
   - 404 Not Found: Trip not found OR rating not found

5. **Logging:** Use structured logging:

   ```typescript
   this.logger.log('Rating retrieved', {
     ratingId: rating.id,
     tripId,
     userId,
     userRole,
   });
   ```

6. **DTO Mapping:** Never expose database models directly - always use mapToDto()

7. **Dependency Injection:** Use NestJS DI, never instantiate with `new`

### Testing Requirements

[Source: architecture/section-14-testing-strategy.md]

**Unit Tests (60% of testing effort):**

Test RatingsService.getRatingByTripId in isolation with mocked dependencies:

- Mock RatingsRepository
- Mock TripService client
- Test scenarios:
  - Passenger views their own rating → returns full RatingDto
  - Driver views rating for their trip → returns RatingDto without passengerId
  - Passenger attempts to view different passenger's rating → ForbiddenException
  - Driver attempts to view different driver's rating → ForbiddenException
  - User views rating for non-existent trip → NotFoundException
  - User views rating for trip without rating → NotFoundException
  - Verify authorization logic is correct for both PASSENGER and DRIVER roles

**Integration Tests (30% of testing effort):**

Test GET /trips/{tripId}/rating endpoint end-to-end:

- Test scenarios:
  - Passenger GET with their token → 200, full rating response
  - Driver GET with their token → 200, rating without passengerId
  - Different passenger GET → 403 Forbidden
  - Different driver GET → 403 Forbidden
  - GET for trip without rating → 404 Not Found
  - GET for non-existent trip → 404 Not Found
  - GET without authentication → 401 Unauthorized
- Verify response structure matches RatingDto
- Verify passengerId is excluded for driver view
- Verify timestamps are ISO 8601 format

**Coverage Target:** Minimum 80% code coverage for new code

**Test File Locations:**

- Unit tests: `test/unit/ratings/ratings.service.spec.ts`
- Integration tests: `test/integration/ratings.e2e-spec.ts`

### Implementation Notes

**RatingsService.getRatingByTripId Method (Pseudocode):**

```typescript
async getRatingByTripId(tripId: string, userId: string, userRole: UserRole): Promise<RatingDto> {
  // 1. Fetch trip from TripService
  const trip = await this.tripServiceClient.getTripById(tripId);
  if (!trip) {
    throw new NotFoundException(`Trip ${tripId} not found`);
  }

  // 2. Authorization: verify user is trip participant
  if (userRole === UserRole.PASSENGER) {
    if (trip.passengerId !== userId) {
      throw new ForbiddenException('You are not authorized to view this rating');
    }
  } else if (userRole === UserRole.DRIVER) {
    if (trip.driverId !== userId) {
      throw new ForbiddenException('You are not authorized to view this rating');
    }
  } else {
    throw new ForbiddenException('Invalid user role');
  }

  // 3. Fetch rating from repository
  const rating = await this.ratingsRepository.findByTripId(tripId);
  if (!rating) {
    throw new NotFoundException(`No rating found for trip ${tripId}`);
  }

  // 4. Log rating retrieval
  this.logger.log('Rating retrieved', {
    ratingId: rating.id,
    tripId,
    userId,
    userRole,
  });

  // 5. Map to DTO with conditional field exclusion
  return this.mapToDto(rating, userRole);
}

private mapToDto(rating: Rating, userRole: UserRole): RatingDto {
  const dto: RatingDto = {
    id: rating.id,
    tripId: rating.tripId,
    stars: rating.stars,
    comment: rating.comment,
    createdAt: rating.createdAt,
  };

  // Include fields based on requester role
  if (userRole === UserRole.PASSENGER) {
    dto.passengerId = rating.passengerId;
    dto.driverId = rating.driverId;
  } else if (userRole === UserRole.DRIVER) {
    // Exclude passengerId for driver view (AC: 3)
    dto.driverId = rating.driverId;
  }

  return dto;
}
```

**RatingsController GET Endpoint:**

```typescript
@ApiOperation({
  summary: 'Get trip rating',
  description: 'Retrieve rating for a specific trip. Passengers can view ratings they submitted; drivers can view ratings for their trips.',
})
@ApiParam({
  name: 'tripId',
  description: 'Trip ID (UUID)',
  example: '123e4567-e89b-12d3-a456-426614174000',
})
@ApiResponse({
  status: 200,
  description: 'Rating retrieved successfully',
  type: RatingDto,
})
@ApiResponse({ status: 401, description: 'Unauthorized - Invalid or missing token' })
@ApiResponse({ status: 403, description: 'Forbidden - Not trip participant' })
@ApiResponse({ status: 404, description: 'Trip not found or no rating exists' })
@Get('trips/:tripId/rating')
@UseGuards(JwtAuthGuard)
async getRating(
  @Param('tripId') tripId: string,
  @CurrentUser() user: User,
): Promise<RatingDto> {
  return this.ratingsService.getRatingByTripId(tripId, user.id, user.role);
}
```

### Future Enhancements (Not in This Story)

- **Story 6.3:** Calculate and store driver average rating
- **Story 6.4:** Public driver rating profile endpoint
- **Story 6.5:** Driver view of their own ratings
- **Story 6.6:** Platform-wide rating analytics
- **Phase 2 Enhancements:**
  - Rating moderation (flag inappropriate comments)
  - Driver response to ratings
  - Rating trends over time

---

## Testing

### Test File Locations

[Source: architecture/section-14-testing-strategy.md]

- **Unit Tests:** `test/unit/ratings/ratings.service.spec.ts`
- **Integration Tests:** `test/integration/ratings.e2e-spec.ts`

### Test Coverage Requirements

- Minimum 80% line coverage for new code
- All acceptance criteria must have corresponding test cases
- Test both success and error scenarios
- Verify authorization checks are enforced correctly
- Verify conditional field exclusion (passengerId for driver view)

### Test Frameworks

- **Jest:** Unit and integration testing
- **Supertest:** HTTP API testing
- **@nestjs/testing:** NestJS test utilities
- **Prisma:** Database testing with test database

---

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-01 | 0.1     | Story created | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
