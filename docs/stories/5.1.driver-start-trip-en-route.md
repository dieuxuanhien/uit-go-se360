# Story 5.1: Driver Start Trip (En Route to Pickup)

## Status

Ready for Review

## Story

**As a** driver who accepted a trip,
**I want** to mark that I'm en route to the pickup location,
**so that** the passenger knows I'm on my way.

## Acceptance Criteria

1. `POST /api/trips/{trip_id}/start-pickup` endpoint implemented
2. Endpoint updates trip status from 'DRIVER_ASSIGNED' to 'EN_ROUTE_TO_PICKUP'
3. Database migration adds `started_at` timestamp column to trips table (if not exists)
4. started_at is set to current timestamp
5. Endpoint returns 200 with updated trip object
6. Endpoint returns 400 if trip status is not 'DRIVER_ASSIGNED'
7. Endpoint returns 404 if trip does not exist
8. Authentication ensures only the assigned driver can start the trip
9. Endpoint returns 403 if different driver attempts to start trip
10. Unit tests cover status transition validation
11. Integration tests verify trip status and timestamp updates persist

## Tasks / Subtasks

- [x] **Task 1: Add EN_ROUTE_TO_PICKUP Status to TripStatus Enum** (AC: 2)
  - [x] Update `services/trip-service/prisma/schema.prisma`
  - [x] Add `EN_ROUTE_TO_PICKUP` value to `TripStatus` enum
  - [x] Run Prisma migration: `npx prisma migrate dev --name add_en_route_status`
  - [x] Verify migration generated successfully in `prisma/migrations/`

- [x] **Task 2: Add started_at Column to Trip Model** (AC: 3, 4)
  - [x] Update `prisma/schema.prisma` Trip model
  - [x] Add `startedAt DateTime? @map("started_at")` field if not already present
  - [x] Note: Column may already exist from previous stories - check schema first
  - [x] Run Prisma migration if needed: `npx prisma migrate dev --name add_started_at`
  - [x] Regenerate Prisma Client: `npx prisma generate`

- [x] **Task 3: Implement startPickup Method in TripsService** (AC: 1, 2, 4, 5, 6, 7, 8, 9)
  - [x] Add method `startPickup(tripId: string, driverId: string): Promise<TripDto>`
  - [x] Fetch trip from repository using `tripsRepository.findById(tripId)`
  - [x] Validate trip exists - throw `NotFoundException` if null (AC: 7)
  - [x] Validate current status is `DRIVER_ASSIGNED` - throw `BadRequestException` if not (AC: 6)
  - [x] Validate authenticated driver matches trip.driverId - throw `ForbiddenException` if different (AC: 8, 9)
  - [x] Update trip: status to `EN_ROUTE_TO_PICKUP`, startedAt to `new Date()`
  - [x] Return mapped TripDto with updated values (AC: 5)
  - [x] Add structured logging for status transition

- [x] **Task 4: Add startPickup Method to TripsRepository** (AC: 2, 4)
  - [x] Open `services/trip-service/src/trips/trips.repository.ts`
  - [x] Add method `async updateStatus(tripId: string, status: TripStatus, startedAt?: Date): Promise<Trip>`
  - [x] Use Prisma update to set status and optionally startedAt
  - [x] Handle Prisma errors and throw `InternalServerErrorException`
  - [x] Return updated Trip model

- [x] **Task 5: Add POST Endpoint to TripsController** (AC: 1, 8)
  - [x] Open `services/trip-service/src/trips/trips.controller.ts`
  - [x] Add `@Post(':id/start-pickup')` endpoint
  - [x] Apply `@UseGuards(JwtAuthGuard, RolesGuard)` for authentication
  - [x] Apply `@Roles('DRIVER')` decorator - only drivers can start pickup
  - [x] Extract trip ID from `@Param('id')`
  - [x] Extract authenticated user from `@CurrentUser()` decorator
  - [x] Call `tripsService.startPickup(id, user.id)`
  - [x] Return TripDto response
  - [x] Add Swagger documentation: `@ApiOperation()`, `@ApiResponse()` for 200, 400, 403, 404, 401

- [x] **Task 6: Write Unit Tests for startPickup** (AC: 10)
  - [x] Create or update `test/unit/trips/trips.service.spec.ts`
  - [x] Mock TripsRepository
  - [x] **Test Scenarios:**
    - [x] Valid startPickup: status DRIVER_ASSIGNED → EN_ROUTE_TO_PICKUP, startedAt set
    - [x] Trip not found → throws NotFoundException
    - [x] Trip status not DRIVER_ASSIGNED → throws BadRequestException
    - [x] Different driver attempts to start → throws ForbiddenException
    - [x] Verify repository called with correct parameters
    - [x] Verify response includes updated status and timestamp

- [x] **Task 7: Write Integration Tests for POST Endpoint** (AC: 11)
  - [x] Create or update `test/integration/trips.e2e-spec.ts`
  - [x] Setup: Create test trip with DRIVER_ASSIGNED status, authenticated driver
  - [x] **Integration Tests:**
    - [x] POST /trips/{id}/start-pickup with valid driver token → 200, status updated
    - [x] Verify database updated: status = EN_ROUTE_TO_PICKUP, startedAt populated
    - [x] POST with different driver token → 403 Forbidden
    - [x] POST with invalid trip status → 400 Bad Request
    - [x] POST with non-existent trip ID → 404 Not Found
    - [x] POST without authentication token → 401 Unauthorized
    - [x] Response body structure matches TripDto schema

- [x] **Task 8: Update API Documentation** (AC: All)
  - [x] Update `services/trip-service/README.md`
  - [x] Document POST /trips/{id}/start-pickup endpoint
  - [x] Request format: Requires JWT Bearer token, trip ID in path, no body
  - [x] Response format with TripDto structure
  - [x] Authorization rules (only assigned driver)
  - [x] Error responses (401, 403, 404, 400)
  - [x] Add example curl command

---

## Dev Notes

### Epic Context

This is the first story in **Epic 5: Trip Execution & Completion**. Previous epics established the complete trip request flow through driver acceptance (Epic 4). This epic focuses on the active trip tracking from driver en route through ride completion.

**Trip State Flow Context:**

- Epic 4 ended with trips in `DRIVER_ASSIGNED` status (Story 4.6)
- Epic 5 manages the progression: EN_ROUTE_TO_PICKUP → ARRIVED_AT_PICKUP → IN_PROGRESS → COMPLETED
- This story implements the first transition: DRIVER_ASSIGNED → EN_ROUTE_TO_PICKUP

### Previous Story Dependencies

**From Story 4.6 (Driver Accept/Decline Trip):**

- Trips can be in `DRIVER_ASSIGNED` status with driverId populated
- JWT authentication with `@CurrentUser()` decorator is implemented
- `RolesGuard` and `@Roles()` decorator available for role-based access
- TripsService, TripsController, TripsRepository established in `services/trip-service/src/trips/`
- TripDto response format defined
- Authorization patterns established (checking user role and trip ownership)

**From Story 4.7 (Get Trip Details):**

- Trip model includes all timestamp fields (requestedAt, driverAssignedAt, etc.)
- TripDto includes full trip information with nested user data
- Authorization middleware ensures only authorized users can access trip data

### Data Models

[Source: architecture/section-4-data-models.md#4.4-trip-model]

**Current Trip Status Enum:**

```typescript
enum TripStatus {
  REQUESTED
  FINDING_DRIVER
  NO_DRIVERS_AVAILABLE
  DRIVER_ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
```

**NEW Status to Add:**

```typescript
enum TripStatus {
  REQUESTED
  FINDING_DRIVER
  NO_DRIVERS_AVAILABLE
  DRIVER_ASSIGNED
  EN_ROUTE_TO_PICKUP        // ← NEW
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
```

**Trip Model Schema (Prisma):**

```typescript
model Trip {
  id          String     @id @default(uuid())
  passengerId String     @map("passenger_id")
  driverId    String?    @map("driver_id")
  status      TripStatus @default(REQUESTED)

  pickupLatitude  Decimal @map("pickup_latitude") @db.Decimal(10, 8)
  pickupLongitude Decimal @map("pickup_longitude") @db.Decimal(11, 8)
  pickupAddress   String  @map("pickup_address")

  destinationLatitude  Decimal @map("destination_latitude") @db.Decimal(10, 8)
  destinationLongitude Decimal @map("destination_longitude") @db.Decimal(11, 8)
  destinationAddress   String  @map("destination_address")

  estimatedFare     Int     @map("estimated_fare")
  actualFare        Int?    @map("actual_fare")
  estimatedDistance Decimal @map("estimated_distance") @db.Decimal(10, 2)

  requestedAt        DateTime  @default(now()) @map("requested_at")
  driverAssignedAt   DateTime? @map("driver_assigned_at")
  startedAt          DateTime? @map("started_at")          // ← Check if exists, add if not
  completedAt        DateTime? @map("completed_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  passenger User   @relation("PassengerTrips", fields: [passengerId], references: [id])
  driver    User?  @relation("DriverTrips", fields: [driverId], references: [id])

  @@index([passengerId])
  @@index([driverId])
  @@index([status])
  @@map("trips")
}
```

**Note on startedAt:** This field may already exist in the schema from previous migrations. Check the schema before adding.

**TripDto Response Format:**

```typescript
export interface TripDto {
  id: string;
  passengerId: string;
  driverId: string | null;
  status: TripStatus;
  pickupLatitude: number;
  pickupLongitude: number;
  pickupAddress: string;
  destinationLatitude: number;
  destinationLongitude: number;
  destinationAddress: string;
  estimatedFare: number;
  actualFare: number | null;
  estimatedDistance: number;
  requestedAt: Date;
  driverAssignedAt: Date | null;
  startedAt: Date | null; // ← Include in response
  completedAt: Date | null;
  cancelledAt: Date | null;
  cancellationReason: string | null;
  passenger?: UserDto;
  driver?: UserDto;
}
```

### API Specification

[Source: architecture/section-5-api-specification.md]

**NEW Endpoint:** `POST /api/trips/{trip_id}/start-pickup`

**Authentication:** Required - JWT Bearer token

**Authorization:** Only the assigned DRIVER can start pickup for their trip

**Path Parameters:**

- `trip_id`: UUID - Trip identifier

**Request Body:** None

**Response 200 OK:**

```json
{
  "id": "trip-uuid",
  "passengerId": "passenger-uuid",
  "driverId": "driver-uuid",
  "status": "EN_ROUTE_TO_PICKUP",
  "pickupLatitude": 10.762622,
  "pickupLongitude": 106.660172,
  "pickupAddress": "District 1, Ho Chi Minh City",
  "destinationLatitude": 10.823099,
  "destinationLongitude": 106.629662,
  "destinationAddress": "Tan Binh District, Ho Chi Minh City",
  "estimatedFare": 2500,
  "actualFare": null,
  "estimatedDistance": 8.5,
  "requestedAt": "2025-11-01T10:30:00Z",
  "driverAssignedAt": "2025-11-01T10:31:15Z",
  "startedAt": "2025-11-01T10:32:00Z",
  "completedAt": null,
  "cancelledAt": null,
  "cancellationReason": null
}
```

**Response 400 Bad Request:** Trip status is not DRIVER_ASSIGNED

```json
{
  "error": {
    "code": "INVALID_TRIP_STATUS",
    "message": "Cannot start pickup for trip in {current_status} status. Trip must be in DRIVER_ASSIGNED status.",
    "timestamp": "2025-11-01T10:32:00Z"
  }
}
```

**Response 401 Unauthorized:** Missing/invalid JWT token

```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Authentication required",
    "timestamp": "2025-11-01T10:32:00Z"
  }
}
```

**Response 403 Forbidden:** Different driver attempting to start trip

```json
{
  "error": {
    "code": "FORBIDDEN",
    "message": "Only the assigned driver can start pickup for this trip",
    "timestamp": "2025-11-01T10:32:00Z"
  }
}
```

**Response 404 Not Found:** Trip does not exist

```json
{
  "error": {
    "code": "TRIP_NOT_FOUND",
    "message": "Trip with ID {trip_id} not found",
    "timestamp": "2025-11-01T10:32:00Z"
  }
}
```

### File Locations

[Source: architecture/section-10-unified-project-structure.md]

**Files to Modify:**

- `services/trip-service/prisma/schema.prisma` - Add EN_ROUTE_TO_PICKUP status, verify startedAt field
- `services/trip-service/src/trips/trips.service.ts` - Add startPickup method
- `services/trip-service/src/trips/trips.repository.ts` - Add updateStatus method
- `services/trip-service/src/trips/trips.controller.ts` - Add POST /trips/:id/start-pickup endpoint
- `test/unit/trips/trips.service.spec.ts` - Add unit tests
- `test/integration/trips.e2e-spec.ts` - Add integration tests
- `services/trip-service/README.md` - Update API documentation

**Project Structure Reference:**

```
services/trip-service/
├── prisma/
│   ├── schema.prisma              # Add EN_ROUTE_TO_PICKUP, check startedAt
│   └── migrations/                # New migration files generated
├── src/
│   ├── trips/
│   │   ├── trips.controller.ts    # Add POST /:id/start-pickup endpoint
│   │   ├── trips.service.ts       # Add startPickup method
│   │   ├── trips.repository.ts    # Add updateStatus method
│   │   ├── dto/
│   │   │   └── trip.dto.ts        # Existing TripDto
│   │   └── trips.module.ts
│   └── common/
│       ├── decorators/
│       │   └── current-user.decorator.ts  # Extract user from JWT
│       └── guards/
│           ├── jwt-auth.guard.ts    # Verify JWT
│           └── roles.guard.ts       # Check user role
└── test/
    ├── unit/
    │   └── trips/
    │       └── trips.service.spec.ts  # Add startPickup tests
    └── integration/
        └── trips.e2e-spec.ts          # Add POST endpoint tests
```

### Coding Standards

[Source: architecture/section-15-coding-standards.md]

**Critical Standards for This Story:**

1. **Type Safety:** Use strict TypeScript types, no `any`. Use Prisma-generated types.

2. **Error Handling:** Use NestJS exception classes:
   - `NotFoundException` - Trip not found
   - `BadRequestException` - Invalid status transition
   - `ForbiddenException` - Wrong driver
   - `UnauthorizedException` - Missing/invalid token

3. **Status Transition Validation Pattern:**

   ```typescript
   if (trip.status !== TripStatus.DRIVER_ASSIGNED) {
     throw new BadRequestException(
       `Cannot start pickup for trip in ${trip.status} status. Trip must be in DRIVER_ASSIGNED status.`,
     );
   }
   ```

4. **Authorization Pattern:**

   ```typescript
   if (trip.driverId !== driverId) {
     throw new ForbiddenException('Only the assigned driver can start pickup for this trip');
   }
   ```

5. **HTTP Status Codes:**
   - 200 OK: Successful status update
   - 400 Bad Request: Invalid status transition
   - 401 Unauthorized: Missing/invalid token
   - 403 Forbidden: Wrong driver
   - 404 Not Found: Trip not found

6. **Logging:** Use structured logging with context:

   ```typescript
   this.logger.log('Trip pickup started', {
     tripId,
     driverId,
     previousStatus: TripStatus.DRIVER_ASSIGNED,
     newStatus: TripStatus.EN_ROUTE_TO_PICKUP,
     timestamp: new Date().toISOString(),
   });
   ```

7. **Atomic Updates:** Use Prisma update in single operation:
   ```typescript
   const updatedTrip = await this.prisma.trip.update({
     where: { id: tripId },
     data: {
       status: TripStatus.EN_ROUTE_TO_PICKUP,
       startedAt: new Date(),
     },
   });
   ```

### Testing Requirements

[Source: architecture/section-14-testing-strategy.md]

**Unit Tests (60% of testing effort):**

- Test TripsService startPickup method in isolation
- Mock TripsRepository
- Test scenarios:
  - Valid status transition DRIVER_ASSIGNED → EN_ROUTE_TO_PICKUP
  - Trip not found → NotFoundException
  - Invalid status (not DRIVER_ASSIGNED) → BadRequestException
  - Wrong driver → ForbiddenException
  - Verify startedAt timestamp is set
  - Verify repository called with correct parameters

**Integration Tests (30% of testing effort):**

- Test POST /trips/{id}/start-pickup endpoint end-to-end
- Use real test database with applied migrations
- Test scenarios:
  - Driver starts pickup for assigned trip → 200, status updated
  - Different driver attempts to start → 403 Forbidden
  - Trip in wrong status → 400 Bad Request
  - Non-existent trip → 404 Not Found
  - No authentication → 401 Unauthorized
  - Verify database persistence
  - Verify response body matches TripDto schema

**Coverage Target:** Minimum 80% code coverage for new code

**Test File Locations:**

- Unit tests: `test/unit/trips/trips.service.spec.ts`
- Integration tests: `test/integration/trips.e2e-spec.ts`

**Test Frameworks:**

- Jest: Unit and integration testing
- Supertest: HTTP API testing
- @nestjs/testing: NestJS test utilities

### Implementation Example

**TripsService.startPickup Method:**

```typescript
async startPickup(tripId: string, driverId: string): Promise<TripDto> {
  // Fetch trip
  const trip = await this.tripsRepository.findById(tripId);

  // Validate existence
  if (!trip) {
    throw new NotFoundException(`Trip with ID ${tripId} not found`);
  }

  // Validate status
  if (trip.status !== TripStatus.DRIVER_ASSIGNED) {
    throw new BadRequestException(
      `Cannot start pickup for trip in ${trip.status} status. Trip must be in DRIVER_ASSIGNED status.`
    );
  }

  // Validate driver authorization
  if (trip.driverId !== driverId) {
    this.logger.warn('Unauthorized pickup start attempt', {
      tripId,
      attemptedByDriver: driverId,
      assignedDriver: trip.driverId,
    });
    throw new ForbiddenException('Only the assigned driver can start pickup for this trip');
  }

  // Update trip status
  const updatedTrip = await this.tripsRepository.updateStatus(
    tripId,
    TripStatus.EN_ROUTE_TO_PICKUP,
    new Date()
  );

  this.logger.log('Trip pickup started', {
    tripId,
    driverId,
    previousStatus: TripStatus.DRIVER_ASSIGNED,
    newStatus: TripStatus.EN_ROUTE_TO_PICKUP,
  });

  return this.mapToDto(updatedTrip);
}
```

**TripsController Endpoint:**

```typescript
@ApiOperation({ summary: 'Driver starts en route to pickup location' })
@ApiParam({
  name: 'id',
  description: 'Trip ID (UUID)',
  example: '123e4567-e89b-12d3-a456-426614174000',
})
@ApiResponse({
  status: 200,
  description: 'Trip pickup started successfully',
  type: TripDto,
})
@ApiResponse({ status: 400, description: 'Invalid trip status transition' })
@ApiResponse({ status: 401, description: 'Unauthorized - Invalid or missing token' })
@ApiResponse({ status: 403, description: 'Forbidden - Wrong driver' })
@ApiResponse({ status: 404, description: 'Trip not found' })
@Post(':id/start-pickup')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('DRIVER')
async startPickup(
  @Param('id') id: string,
  @CurrentUser() user: User,
): Promise<TripDto> {
  return this.tripsService.startPickup(id, user.id);
}
```

### State Machine Validation

**Valid Transition:**

- DRIVER_ASSIGNED → EN_ROUTE_TO_PICKUP ✓

**Invalid Transitions (should throw BadRequestException):**

- REQUESTED → EN_ROUTE_TO_PICKUP ✗
- FINDING_DRIVER → EN_ROUTE_TO_PICKUP ✗
- EN_ROUTE_TO_PICKUP → EN_ROUTE_TO_PICKUP ✗ (already en route)
- IN_PROGRESS → EN_ROUTE_TO_PICKUP ✗
- COMPLETED → EN_ROUTE_TO_PICKUP ✗
- CANCELLED → EN_ROUTE_TO_PICKUP ✗

### Future Stories in Epic 5

- **Story 5.2:** Driver Arrive at Pickup (EN_ROUTE_TO_PICKUP → ARRIVED_AT_PICKUP)
- **Story 5.3:** Start Active Trip (ARRIVED_AT_PICKUP → IN_PROGRESS)
- **Story 5.4:** Real-Time Location Updates During Trip
- **Story 5.5:** Complete Trip with Earnings Calculation
- **Story 5.6:** Passenger Cancel Trip
- **Story 5.7:** Get Driver Earnings Summary
- **Story 5.8:** Get Passenger Trip History

---

## Testing

### Test File Locations

[Source: architecture/section-14-testing-strategy.md]

- **Unit Tests:** `test/unit/trips/trips.service.spec.ts`
- **Integration Tests:** `test/integration/trips.e2e-spec.ts`

### Test Coverage Requirements

- Minimum 80% line coverage for new code
- All acceptance criteria must have corresponding test cases
- Test both success and error scenarios
- Verify status transition validation is enforced

### Test Frameworks

- **Jest:** Unit and integration testing
- **Supertest:** HTTP API testing
- **@nestjs/testing:** NestJS test utilities

---

## Change Log

| Date       | Version | Description   | Author   |
| ---------- | ------- | ------------- | -------- |
| 2025-11-01 | 0.1     | Story created | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used

James (Dev Agent)

### Debug Log References

- Migration error with \_prisma_health_check sequence already existing - resolved by resetting database
- HTTP status code was 201 instead of 200 for POST endpoint - fixed by adding @HttpCode(HttpStatus.OK)

### Completion Notes List

- All acceptance criteria implemented and tested
- Unit tests: 21 passed
- Integration tests: 28 passed
- Database migration applied successfully after resolving sequence conflict
- API documentation updated with new endpoint

### File List

- Modified: `services/trip-service/prisma/schema.prisma` - Added EN_ROUTE_TO_PICKUP to TripStatus enum
- Modified: `services/trip-service/prisma/migrations/20251101083658_add_en_route_status/migration.sql` - Fixed migration SQL
- Modified: `services/trip-service/src/trips/trips.service.ts` - Added startPickup method
- Modified: `services/trip-service/src/trips/trips.repository.ts` - Added updateStatus method
- Modified: `services/trip-service/src/trips/trips.controller.ts` - Added POST /trips/:id/start-pickup endpoint
- Modified: `services/trip-service/test/unit/trips/trips.service.spec.ts` - Added unit tests for startPickup
- Modified: `services/trip-service/test/integration/trips.e2e-spec.ts` - Added integration tests for start-pickup endpoint
- Modified: `services/trip-service/README.md` - Updated API documentation
- Modified: `docs/stories/5.1.driver-start-trip-en-route.md` - Updated status and task completion

---

## QA Results

(To be filled by QA agent)
