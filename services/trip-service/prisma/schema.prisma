generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PrismaHealthCheck {
  id Int @id @default(autoincrement())

  @@map("_prisma_health_check")
}

enum UserRole {
  PASSENGER
  DRIVER
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phoneNumber  String   @map("phone_number")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  passengerTrips Trip[] @relation("PassengerTrips")
  driverTrips    Trip[] @relation("DriverTrips")

  @@index([email])
  @@index([role])
  @@map("users")
}

enum TripStatus {
  REQUESTED
  FINDING_DRIVER
  NO_DRIVERS_AVAILABLE
  DRIVER_ASSIGNED
  EN_ROUTE_TO_PICKUP
  ARRIVED_AT_PICKUP
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model Trip {
  id          String     @id @default(uuid())
  passengerId String     @map("passenger_id")
  driverId    String?    @map("driver_id")
  status      TripStatus @default(REQUESTED)

  pickupLatitude  Decimal @map("pickup_latitude") @db.Decimal(10, 8)
  pickupLongitude Decimal @map("pickup_longitude") @db.Decimal(11, 8)
  pickupAddress   String  @map("pickup_address")

  destinationLatitude  Decimal @map("destination_latitude") @db.Decimal(10, 8)
  destinationLongitude Decimal @map("destination_longitude") @db.Decimal(11, 8)
  destinationAddress   String  @map("destination_address")

  estimatedFare     Int     @map("estimated_fare")
  actualFare        Int?    @map("actual_fare")
  estimatedDistance Decimal @map("estimated_distance") @db.Decimal(10, 2)

  requestedAt        DateTime  @default(now()) @map("requested_at")
  driverAssignedAt   DateTime? @map("driver_assigned_at")
  startedAt          DateTime? @map("started_at")
  arrivedAt          DateTime? @map("arrived_at")
  completedAt        DateTime? @map("completed_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancellationReason String?   @map("cancellation_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  passenger User   @relation("PassengerTrips", fields: [passengerId], references: [id])
  driver    User?  @relation("DriverTrips", fields: [driverId], references: [id])

  driverNotifications DriverNotification[]

  @@index([passengerId])
  @@index([driverId])
  @@index([status])
  @@index([requestedAt])
  @@index([completedAt])
  @@index([passengerId, status])
  @@index([driverId, status])
  @@map("trips")
}

model DriverNotification {
  id          String             @id @default(uuid())
  tripId      String             @map("trip_id")
  driverId    String             @map("driver_id")
  status      NotificationStatus @default(PENDING)
  notifiedAt  DateTime           @default(now()) @map("notified_at")
  respondedAt DateTime?          @map("responded_at")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  trip Trip @relation(fields: [tripId], references: [id])

  @@index([tripId])
  @@index([driverId])
  @@index([status])
  @@index([notifiedAt])
  @@index([tripId, status])
  @@index([driverId, status])
  @@map("driver_notifications")
}
